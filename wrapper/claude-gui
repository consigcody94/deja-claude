#!/bin/bash

# Claude GUI Wrapper Script
# Launches the Claude GUI server and opens the browser

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
PORT=${PORT:-3001}
FRONTEND_PORT=${FRONTEND_PORT:-5173}
PID_FILE="/tmp/claude-gui.pid"
LOG_FILE="/tmp/claude-gui.log"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${BLUE}[Claude GUI]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[Claude GUI]${NC} $1"
}

print_error() {
    echo -e "${RED}[Claude GUI]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[Claude GUI]${NC} $1"
}

# Check if server is already running
is_running() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            return 0
        fi
    fi
    return 1
}

# Get the URL to open
get_url() {
    echo "http://localhost:$FRONTEND_PORT"
}

# Open browser
open_browser() {
    local url=$(get_url)
    print_status "Opening browser at $url"

    if command -v xdg-open &>/dev/null; then
        xdg-open "$url" &>/dev/null &
    elif command -v open &>/dev/null; then
        open "$url" &>/dev/null &
    elif command -v wslview &>/dev/null; then
        wslview "$url" &>/dev/null &
    else
        print_warning "Could not detect browser. Please open: $url"
    fi
}

# Start the server
start_server() {
    if is_running; then
        print_warning "Server already running (PID: $(cat $PID_FILE))"
        open_browser
        return 0
    fi

    print_status "Starting Claude GUI server..."

    # Check if dependencies are installed
    if [ ! -d "$PROJECT_DIR/node_modules" ]; then
        print_status "Installing dependencies..."
        cd "$PROJECT_DIR"
        npm install
    fi

    # Start backend server
    cd "$PROJECT_DIR"
    npm run dev > "$LOG_FILE" 2>&1 &
    local pid=$!
    echo $pid > "$PID_FILE"

    # Wait for server to be ready
    print_status "Waiting for server to start..."
    local max_attempts=30
    local attempt=0

    while [ $attempt -lt $max_attempts ]; do
        if curl -s "http://localhost:$PORT/api/health" > /dev/null 2>&1; then
            print_success "Server started successfully!"
            open_browser
            return 0
        fi
        sleep 1
        ((attempt++))
    done

    print_error "Server failed to start. Check logs at $LOG_FILE"
    return 1
}

# Stop the server
stop_server() {
    if ! is_running; then
        print_warning "Server is not running"
        return 0
    fi

    local pid=$(cat "$PID_FILE")
    print_status "Stopping server (PID: $pid)..."

    # Kill the process group
    kill -TERM -$pid 2>/dev/null || kill -TERM $pid 2>/dev/null

    # Wait for it to stop
    local max_attempts=10
    local attempt=0
    while [ $attempt -lt $max_attempts ]; do
        if ! kill -0 "$pid" 2>/dev/null; then
            rm -f "$PID_FILE"
            print_success "Server stopped"
            return 0
        fi
        sleep 1
        ((attempt++))
    done

    # Force kill if still running
    kill -9 -$pid 2>/dev/null || kill -9 $pid 2>/dev/null
    rm -f "$PID_FILE"
    print_success "Server stopped (forced)"
}

# Show status
show_status() {
    if is_running; then
        print_success "Server is running (PID: $(cat $PID_FILE))"
        print_status "Backend: http://localhost:$PORT"
        print_status "Frontend: $(get_url)"
    else
        print_warning "Server is not running"
    fi
}

# Show logs
show_logs() {
    if [ -f "$LOG_FILE" ]; then
        tail -f "$LOG_FILE"
    else
        print_warning "No log file found"
    fi
}

# Print usage
usage() {
    cat << EOF
Claude GUI - Web Interface for Claude Code CLI

Usage: claude-gui [COMMAND]

Commands:
    start       Start the GUI server and open browser (default)
    stop        Stop the GUI server
    restart     Restart the GUI server
    status      Show server status
    logs        Show server logs (tail -f)
    open        Open browser to GUI (if server is running)
    help        Show this help message

Options:
    --port PORT         Set backend port (default: 3001)
    --frontend-port     Set frontend port (default: 5173)

Examples:
    claude-gui                  # Start server and open browser
    claude-gui start            # Same as above
    claude-gui stop             # Stop the server
    claude-gui --port 8080      # Start on custom port

Environment Variables:
    PORT                Backend server port (default: 3001)
    FRONTEND_PORT       Frontend dev server port (default: 5173)
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --port)
            PORT="$2"
            shift 2
            ;;
        --frontend-port)
            FRONTEND_PORT="$2"
            shift 2
            ;;
        start)
            start_server
            exit $?
            ;;
        stop)
            stop_server
            exit $?
            ;;
        restart)
            stop_server
            sleep 2
            start_server
            exit $?
            ;;
        status)
            show_status
            exit 0
            ;;
        logs)
            show_logs
            exit 0
            ;;
        open)
            if is_running; then
                open_browser
            else
                print_error "Server is not running. Start it first with: claude-gui start"
                exit 1
            fi
            exit 0
            ;;
        help|--help|-h)
            usage
            exit 0
            ;;
        *)
            print_error "Unknown command: $1"
            usage
            exit 1
            ;;
    esac
done

# Default action: start
start_server
